rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証済みユーザーのみ操作可能（基本ルール）
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // 統合ユーザーかどうかを判定する関数
    function isUnifiedUser() {
      return exists(/databases/$(database)/documents/unified_users/$(request.auth.uid));
    }
    
    // CRMアクセス権限チェックの関数
    function hasCrmAccess() {
      return exists(/databases/$(database)/documents/business_users/$(request.auth.uid));
    }
    
    // SNSアクセス権限チェックの関数
    function hasSnsAccess() {
      return isUnifiedUser() && 
             get(/databases/$(database)/documents/unified_users/$(request.auth.uid)).data.permissions.sns == true;
    }
    
    // 管理者権限チェックの関数
    function isAdmin() {
      return (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'root']) ||
             (exists(/databases/$(database)/documents/business_users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/business_users/$(request.auth.uid)).data.role in ['admin', 'root']);
    }
    
    // 統合ユーザーコレクション
    match /unified_users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // ビジネスユーザーコレクション（CRM用・後方互換性）
    match /business_users/{businessUserId} {
      allow read, write: if request.auth != null && request.auth.uid == businessUserId;
      allow create: if request.auth != null && request.auth.uid == businessUserId;
    }
    
    // ユーザーコレクションの特別なルール（SNS用）
    match /users/{userId} {
      // CRMアクセス権限またはSNSアクセス権限があるユーザーは全てのusersデータを読み取り可能
      allow read: if request.auth != null && (hasCrmAccess() || hasSnsAccess());
      
      // 作成・更新はユーザー自身、管理者、またはbusiness_usersが存在するユーザーが可能
      allow create, update: if request.auth != null && (
        request.auth.uid == userId || 
        isAdmin() || 
        hasSnsAccess() ||
        exists(/databases/$(database)/documents/business_users/$(request.auth.uid))
      );
      
      // 削除は管理者のみ可能
      allow delete: if request.auth != null && isAdmin();
    }
    
    // アバター情報（SNS用）
    match /avatars/{avatarId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == resource.data.user_id || hasCrmAccess()
      );
      allow create: if request.auth != null && (
        request.auth.uid == request.resource.data.user_id || hasSnsAccess()
      );
    }
    
    // ウォレット情報（SNS用およびCRM用統合）
    match /wallets/{walletId} {
      // CRMアクセス権限があるユーザーは全てのwalletデータを読み取り可能
      // 一般ユーザーは自分のデータのみ読み取り・書き込み可能
      allow read: if request.auth != null && (
        hasCrmAccess() || request.auth.uid == resource.data.user_id
      );
      allow write: if request.auth != null && (
        hasCrmAccess() || request.auth.uid == resource.data.user_id
      );
      allow create: if request.auth != null && (
        hasCrmAccess() || request.auth.uid == request.resource.data.user_id
      );
      // 削除は管理者のみ可能
      allow delete: if request.auth != null && isAdmin();
    }
    
    // 配送先住所（SNS用）
    match /shipping_addresses/{addressId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == resource.data.user_id || hasCrmAccess()
      );
      allow create: if request.auth != null && request.auth.uid == request.resource.data.user_id;
    }
    
    // メール送信コレクション（Trigger Email from Firestore用）
    match /mail/{mailId} {
      // CRMアクセス権限があるユーザーはメール送信可能
      allow read, write, create: if request.auth != null && hasCrmAccess();
      // 一般ユーザーは自分のメールのみ操作可能
      allow read, write: if request.auth != null && request.auth.uid == resource.data.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
    }
    
    // メールテンプレートとユーザー情報（mails コレクション用）
    match /mails/{docId} {
      // CRMアクセス権限があるユーザーは全てのメール関連データにアクセス可能
      allow read, write, create: if request.auth != null && hasCrmAccess();
      // 一般ユーザーは自分の情報のみアクセス可能
      allow read, write: if request.auth != null && request.auth.uid == docId;
    }

    // 会社情報（CRM用）
    match /companies/{companyId} {
      // CRMアクセス権限があるユーザーは全ての会社データを読み取り可能
      allow read: if request.auth != null && hasCrmAccess();
      // CRMアクセス権限があるユーザーは会社を作成可能
      allow create: if request.auth != null && hasCrmAccess();
      // 更新・削除は管理者のみ可能
      allow update, delete: if request.auth != null && isAdmin();
    }

    // 通知情報（全システム共通）
    match /notifications/{notificationId} {
      // 認証済みユーザーは自分の通知を読み取り可能
      allow read: if request.auth != null && request.auth.uid == resource.data.user_id;
      // CRMアクセス権限があるユーザーは全ての通知を読み取り可能
      allow read: if request.auth != null && hasCrmAccess();
      // CRMアクセス権限があるユーザーは通知を作成可能
      allow create: if request.auth != null && hasCrmAccess();
      // 更新・削除は管理者のみ可能
      allow update, delete: if request.auth != null && isAdmin();
    }

    // 認証メール関連（Cloud Functions用）
    match /auth_mails/{mailId} {
      // CRMアクセス権限があるユーザーは全てのメール関連データにアクセス可能
      allow read, write, create: if request.auth != null && hasCrmAccess();
      // 一般ユーザーは自分の認証メールのみアクセス可能
      allow read, write: if request.auth != null && request.auth.uid == resource.data.uid;
    }
  }
}
