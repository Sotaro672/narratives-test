<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Extensions メール送信テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .test-button {
            background-color: #2196F3;
        }
        .test-button:hover {
            background-color: #1976D2;
        }
        input[type="email"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
            margin: 10px 5px;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .config-info {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .config-info h3 {
            margin-top: 0;
            color: #2c5aa0;
        }
        .config-info ul {
            margin-left: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firebase Extensions メール送信テスト</h1>
        
        <div class="config-info">
            <h3>現在の設定情報</h3>
            <ul>
                <li><strong>SMTP接続:</strong> smtps://caotailangaogang@gmail.com:••••@smtp.gmail.com:465</li>
                <li><strong>メールコレクション:</strong> mails</li>
                <li><strong>デフォルト送信者:</strong> caotailangaogang@gmail.com</li>
                <li><strong>認証タイプ:</strong> Username/Password</li>
                <li><strong>Firestore Location:</strong> asia-northeast1</li>
            </ul>
        </div>

        <div class="section">
            <h2>認証状態</h2>
            <p>Firebase Extensions のテストには認証が必要です。自動的に匿名認証を行います。</p>
            <div id="authStatus">認証中...</div>
        </div>

        <div class="section">
            <h2>1. 基本的なメール送信テスト</h2>
            <p>Firebase Extensions "Trigger Email from Firestore" の基本動作を確認します。</p>
            
            <input type="email" id="basicTestEmail" placeholder="送信先メールアドレス" value="caotailangaogang@gmail.com">
            <button class="test-button" onclick="runBasicEmailTest()">基本テスト実行</button>
            
            <div class="loading" id="basicLoading">送信中...</div>
            <div id="basicResult"></div>
        </div>

        <div class="section">
            <h2>2. 認証メールテンプレートテスト</h2>
            <p>カスタム認証メールテンプレートの動作を確認します。</p>
            
            <input type="email" id="authTestEmail" placeholder="送信先メールアドレス" value="caotailangaogang@gmail.com">
            <button class="test-button" onclick="runAuthEmailTest()">認証メールテスト実行</button>
            
            <div class="loading" id="authLoading">送信中...</div>
            <div id="authResult"></div>
        </div>

        <div class="section">
            <h2>3. Firestoreメールキュー確認</h2>
            <p>Firestoreの mailsコレクションを確認して、メール送信の状況を確認します。</p>
            
            <button onclick="checkMailQueue()">メールキュー確認</button>
            <button onclick="window.open('https://console.firebase.google.com/project/narratives-test/firestore/data/~2Fmails', '_blank')">Firestore Console で確認</button>
            
            <div id="queueResult"></div>
        </div>

        <div class="section">
            <h2>4. Firebase Extensions ログ確認</h2>
            <p>Firebase Extensions の実行ログを確認して、エラーがないかチェックします。</p>
            
            <button onclick="window.open('https://console.firebase.google.com/project/narratives-test/extensions', '_blank')">Extensions Console で確認</button>
            <button onclick="window.open('https://console.firebase.google.com/project/narratives-test/functions/logs', '_blank')">Functions ログを確認</button>
        </div>

        <div class="section">
            <h2>5. トラブルシューティング</h2>
            <div class="config-info">
                <h3>メールが送信されない場合の確認事項：</h3>
                <ul>
                    <li>Gmail アプリパスワードが正しく設定されているか</li>
                    <li>SMTP接続URI に特殊文字が含まれていないか</li>
                    <li>Firestore の mails コレクションにドキュメントが追加されているか</li>
                    <li>Firebase Extensions の状態が「アクティブ」になっているか</li>
                    <li>Firebase Functions のログにエラーが出ていないか</li>
                </ul>
                
                <h3>よくある問題と解決方法：</h3>
                <ul>
                    <li><strong>認証エラー:</strong> Gmail アプリパスワードを再生成する</li>
                    <li><strong>接続エラー:</strong> SMTP URI の形式を確認する</li>
                    <li><strong>権限エラー:</strong> Firebase Extensions の権限設定を確認する</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDKをimport
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase設定 (実際の設定値)
        const firebaseConfig = {
            apiKey: "AIzaSyDZuEVrJs1zlkuCqcnGxVFEgqehciGrIQI",
            authDomain: "narratives-test-64976.firebaseapp.com",
            projectId: "narratives-test-64976",
            storageBucket: "narratives-test-64976.firebasestorage.app",
            messagingSenderId: "221090465383",
            appId: "1:221090465383:web:49c7e3b0009547c99576c2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // 匿名認証を行う
        let authUser = null;
        
        async function initAuth() {
            try {
                const userCredential = await signInAnonymously(auth);
                authUser = userCredential.user;
                console.log('匿名認証成功:', authUser.uid);
                document.getElementById('authStatus').innerHTML = `<div class="result success">認証成功: ${authUser.uid}</div>`;
            } catch (error) {
                console.error('認証エラー:', error);
                document.getElementById('authStatus').innerHTML = `<div class="result error">認証エラー: ${error.message}</div>`;
            }
        }

        // 認証状態の監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authUser = user;
                console.log('認証状態変更: ログイン済み', user.uid);
            } else {
                authUser = null;
                console.log('認証状態変更: 未ログイン');
            }
        });

        // ページ読み込み時に認証を初期化
        window.addEventListener('load', initAuth);

        // グローバル関数を定義
        window.runBasicEmailTest = async function() {
            if (!authUser) {
                document.getElementById('basicResult').innerHTML = '<div class="result error">認証が完了していません。しばらく待ってから再試行してください。</div>';
                return;
            }

            const email = document.getElementById('basicTestEmail').value;
            const loading = document.getElementById('basicLoading');
            const result = document.getElementById('basicResult');
            
            loading.style.display = 'block';
            result.innerHTML = '';
            
            try {
                const testMailData = {
                    to: [email],
                    message: {
                        subject: 'Firebase Extensions テストメール',
                        html: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                            <h2 style="color: #4CAF50;">Firebase Extensions テストメール</h2>
                            <p>これはFirebase Extensions "Trigger Email from Firestore" の動作確認用のテストメールです。</p>
                            <p>送信時刻: ${new Date().toLocaleString('ja-JP')}</p>
                            <p>このメールが届いている場合、Firebase Extensions が正常に動作しています。</p>
                        </div>
                        `
                    },
                    createdAt: new Date(),
                    testType: 'basic_test'
                };

                const mailRef = await addDoc(collection(db, 'mails'), testMailData);
                
                loading.style.display = 'none';
                result.innerHTML = `<div class="result success">
                    <strong>テストメール送信成功!</strong><br>
                    ドキュメントID: ${mailRef.id}<br>
                    送信先: ${email}<br>
                    Firebase Extensions が処理するまで数分かかる場合があります。
                </div>`;
                
            } catch (error) {
                loading.style.display = 'none';
                result.innerHTML = `<div class="result error">
                    <strong>エラー:</strong> ${error.message}
                </div>`;
            }
        };

        window.runAuthEmailTest = async function() {
            if (!authUser) {
                document.getElementById('authResult').innerHTML = '<div class="result error">認証が完了していません。しばらく待ってから再試行してください。</div>';
                return;
            }

            const email = document.getElementById('authTestEmail').value;
            const loading = document.getElementById('authLoading');
            const result = document.getElementById('authResult');
            
            loading.style.display = 'block';
            result.innerHTML = '';
            
            try {
                const authMailData = {
                    to: [email],
                    message: {
                        subject: 'テスト: Narrativesへようこそ！',
                        html: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                            <h2 style="color: #333;">お疲れ様です。Narratives CRMシステムへの招待が完了しました。</h2>
                            
                            <div style="background-color: #f5f5f5; padding: 20px; border-radius: 5px; margin: 20px 0;">
                                <h3>【ログイン情報】</h3>
                                <p>・メールアドレス: <strong>${email}</strong></p>
                                <p>・一時パスワード: <strong>TestPassword123</strong></p>
                            </div>

                            <div style="text-align: center; margin: 30px 0;">
                                <a href="https://narratives-crm-site.web.app/login" 
                                   style="background-color: #4CAF50; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">
                                    Narratives CRMにログイン
                                </a>
                            </div>

                            <p style="color: #666; font-size: 12px;">テスト送信: ${new Date().toLocaleString('ja-JP')}</p>
                        </div>
                        `
                    },
                    createdAt: new Date(),
                    testType: 'auth_test'
                };

                const mailRef = await addDoc(collection(db, 'mails'), authMailData);
                
                loading.style.display = 'none';
                result.innerHTML = `<div class="result success">
                    <strong>認証メールテスト送信成功!</strong><br>
                    ドキュメントID: ${mailRef.id}<br>
                    送信先: ${email}<br>
                    Firebase Extensions が処理するまで数分かかる場合があります。
                </div>`;
                
            } catch (error) {
                loading.style.display = 'none';
                result.innerHTML = `<div class="result error">
                    <strong>エラー:</strong> ${error.message}
                </div>`;
            }
        };

        window.checkMailQueue = async function() {
            const result = document.getElementById('queueResult');
            result.innerHTML = '<div class="loading">メールキューを確認中...</div>';
            
            try {
                const q = query(collection(db, 'mails'), orderBy('createdAt', 'desc'), limit(10));
                const querySnapshot = await getDocs(q);
                
                let html = '<div class="result success"><h4>最新10件のメールキュー:</h4><ul>';
                
                if (querySnapshot.empty) {
                    html += '<li>メールキューにドキュメントがありません</li>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const createdAt = data.createdAt?.toDate?.() || new Date(data.createdAt);
                        html += `
                        <li>
                            <strong>ID:</strong> ${doc.id}<br>
                            <strong>送信先:</strong> ${data.to?.join(', ') || 'N/A'}<br>
                            <strong>件名:</strong> ${data.message?.subject || 'N/A'}<br>
                            <strong>作成日時:</strong> ${createdAt.toLocaleString('ja-JP')}<br>
                            <strong>配信状況:</strong> ${data.delivery?.state || '処理待ち'}<br>
                            ${data.delivery?.error ? `<strong>エラー:</strong> ${data.delivery.error}<br>` : ''}
                        </li><br>
                        `;
                    });
                }
                
                html += '</ul></div>';
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `<div class="result error">
                    <strong>エラー:</strong> ${error.message}
                </div>`;
            }
        };
    </script>
</body>
</html>
